---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { PUBLIC_WORKER_URL } from 'astro:env/server';

const workerUrl = PUBLIC_WORKER_URL || 'http://localhost:8787';
---

<BaseLayout title="Admin Panel">
  <h1>Admin Panel</h1>
  <p style="color: #666; margin-bottom: 2rem;">
    Your one-stop for managing webcomic content. This page is protected by Cloudflare Access.
  </p>

  <div style="display: flex; flex-direction: column; gap: 1rem; max-width: 300px;">
    <button
      id="btn-upload"
      style="padding: 1rem; font-size: 1rem; cursor: pointer; background: #0066cc; color: white; border: none; border-radius: 4px;"
    >
      üì§ Upload New Comic
    </button>

    <button
      id="btn-modify"
      style="padding: 1rem; font-size: 1rem; cursor: pointer; background: #4a9eff; color: white; border: none; border-radius: 4px;"
    >
      ‚úèÔ∏è Modify Comic
    </button>

    <button
      id="btn-ai"
      style="padding: 1rem; font-size: 1rem; cursor: pointer; background: #9b59b6; color: white; border: none; border-radius: 4px;"
    >
      ü§ñ Modify Site with AI
    </button>

    <a
      href="https://dash.cloudflare.com/?to=/:account/web-analytics/sites/09b9c80391304fa2b9a307bae1aca765"
      target="_blank"
      rel="noopener noreferrer"
      style="display: block; padding: 1rem; font-size: 1rem; cursor: pointer; background: #f5a623; color: white; border: none; border-radius: 4px; text-decoration: none; text-align: center;"
    >
      üìä View Analytics
    </a>
  </div>

  <!-- Upload New Comic Form -->
  <div
    id="upload-form"
    style="display: none; margin-top: 2rem; padding: 1rem; background: #f5f5f5; border-radius: 4px;"
  >
    <h2>Upload New Comic</h2>
    <form id="comic-form" style="display: flex; flex-direction: column; gap: 1rem;">
      <label>
        Title:
        <input type="text" name="title" required style="width: 100%; padding: 0.5rem;" />
      </label>
      <label>
        Slug:
        <input type="text" name="slug" required style="width: 100%; padding: 0.5rem;" />
      </label>
      <label>
        Image:
        <input type="file" name="image" accept="image/png,image/jpeg,image/webp,image/gif,image/avif" required />
      </label>
      <label>
        Alt Text:
        <input type="text" name="altText" style="width: 100%; padding: 0.5rem;" />
      </label>
      <label>
        Transcript:
        <textarea name="transcript" rows="4" style="width: 100%; padding: 0.5rem;"></textarea>
      </label>
      <button type="submit" style="padding: 0.75rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Submit
      </button>
    </form>
    <div id="form-result" style="margin-top: 1rem;"></div>
  </div>

  <!-- Modify Comic UI -->
  <div
    id="modify-form"
    style="display: none; margin-top: 2rem; padding: 1rem; background: #e8f4fc; border-radius: 4px;"
  >
    <h2>Modify Comic</h2>
    
    <div style="margin-bottom: 1rem;">
      <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
        <input type="checkbox" id="show-hidden-toggle" />
        Show hidden comics only
      </label>
    </div>
    
    <div id="comic-selector" style="margin-bottom: 1rem;">
      <label>
        Select Comic:
        <select id="comic-select" style="width: 100%; padding: 0.5rem; margin-top: 0.25rem;">
          <option value="">Loading comics...</option>
        </select>
      </label>
    </div>

    <form id="modify-comic-form" style="display: none; flex-direction: column; gap: 1rem;">
      <input type="hidden" name="comicId" id="modify-comic-id" />
      
      <div style="background: #f0f0f0; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem;">
        <img id="modify-preview" src="" alt="Current comic" style="max-width: 200px; max-height: 150px; display: none;" />
        <div id="hidden-badge" style="display: none; margin-top: 0.5rem; padding: 0.25rem 0.5rem; background: #ffc107; color: #000; border-radius: 4px; font-size: 0.8rem; width: fit-content;">
          üôà Hidden
        </div>
      </div>
      
      <label>
        Title:
        <input type="text" name="title" id="modify-title" style="width: 100%; padding: 0.5rem;" />
      </label>
      <label>
        Slug:
        <input type="text" name="slug" id="modify-slug" style="width: 100%; padding: 0.5rem;" />
      </label>
      <label>
        Replace Image (optional):
        <input type="file" name="image" id="modify-image" accept="image/png,image/jpeg,image/webp,image/gif,image/avif" />
      </label>
      <label>
        Alt Text:
        <input type="text" name="altText" id="modify-alt" style="width: 100%; padding: 0.5rem;" />
      </label>
      <label>
        Transcript:
        <textarea name="transcript" id="modify-transcript" rows="4" style="width: 100%; padding: 0.5rem;"></textarea>
      </label>
      
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <button type="submit" style="padding: 0.75rem 1rem; background: #4a9eff; color: white; border: none; border-radius: 4px; cursor: pointer;">
          üíæ Save Changes
        </button>
        <button type="button" id="btn-toggle-hide" style="padding: 0.75rem 1rem; background: #ffc107; color: #000; border: none; border-radius: 4px; cursor: pointer;">
          üôà Hide
        </button>
        <button type="button" id="btn-delete" style="padding: 0.75rem 1rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
          üóëÔ∏è Delete
        </button>
      </div>
    </form>
    <div id="modify-result" style="margin-top: 1rem;"></div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 400px; margin: 1rem;">
      <h3 style="margin-bottom: 1rem; color: #dc3545;">‚ö†Ô∏è Delete Comic Permanently?</h3>
      <p style="margin-bottom: 1rem;">This action cannot be undone. The comic "<span id="delete-comic-title"></span>" will be permanently removed from Sanity.</p>
      <div style="display: flex; gap: 1rem; justify-content: flex-end;">
        <button id="delete-cancel" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Cancel
        </button>
        <button id="delete-confirm" style="padding: 0.5rem 1rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Delete Forever
        </button>
      </div>
    </div>
  </div>

  <!-- AI Site Modification -->
  <div
    id="ai-mod-panel"
    style="display: none; margin-top: 2rem; padding: 1rem; background: #e7d4f5; border-radius: 4px; max-width: 700px;"
  >
    <h2>ü§ñ Modify Site with AI</h2>
    <p style="color: #666; margin-bottom: 1rem;">
      Describe what you want to change. Copilot will create a PR with the changes for you to review.
    </p>
    
    <!-- New Request Form -->
    <details id="ai-new-request" open style="margin-bottom: 1rem;">
      <summary style="cursor: pointer; font-weight: bold; padding: 0.5rem 0;">‚ûï New Request</summary>
      <div style="padding: 0.5rem 0;">
        <textarea 
          id="ai-description" 
          rows="3" 
          placeholder="e.g., Add a dark mode toggle to the site header..."
          style="width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; resize: vertical;"
        ></textarea>
        <button 
          id="ai-submit" 
          style="margin-top: 0.5rem; padding: 0.75rem 1.5rem; background: #9b59b6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem;"
        >
          üöÄ Submit Request
        </button>
        <div id="ai-request-result" style="margin-top: 0.5rem;"></div>
      </div>
    </details>
    
    <!-- Previous Requests List -->
    <div id="ai-requests-list" style="margin-top: 1rem;">
      <h3 style="margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
        üìã Previous Requests
        <button id="ai-refresh-list" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: #9b59b6; color: white; border: none; border-radius: 4px; cursor: pointer;">‚Üª Refresh</button>
      </h3>
      <div id="ai-list-content" style="max-height: 300px; overflow-y: auto;">
        <p style="color: #666;">Loading...</p>
      </div>
    </div>
    
    <!-- Selected Request Detail Panel -->
    <div id="ai-detail-panel" style="display: none; margin-top: 1rem; padding: 1rem; background: white; border-radius: 4px; border: 2px solid #9b59b6;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
        <h3 style="margin: 0;" id="ai-detail-title">Request Details</h3>
        <button id="ai-close-detail" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">‚úï</button>
      </div>
      <div id="ai-detail-status" style="margin-bottom: 0.5rem;"></div>
      
      <!-- Preview Section -->
      <div id="ai-preview-section" style="display: none; margin-top: 1rem;">
        <h4 style="margin: 0 0 0.5rem 0;">Preview Your Changes</h4>
        <div style="border: 2px solid #9b59b6; border-radius: 4px; overflow: hidden;">
          <div style="background: #9b59b6; color: white; padding: 0.5rem; font-size: 0.8rem;">
            ‚ö†Ô∏è This is a preview of the proposed changes
          </div>
          <iframe 
            id="ai-preview-iframe" 
            src="" 
            style="width: 100%; height: 350px; border: none;"
          ></iframe>
        </div>
        <a id="ai-preview-link" href="" target="_blank" style="display: inline-block; margin-top: 0.5rem; color: #9b59b6;">
          Open preview in new tab ‚Üí
        </a>
      </div>
      
      <!-- Request Changes Section -->
      <div id="ai-revise-section" style="display: none; margin-top: 1rem; padding: 1rem; background: #f8f4fc; border-radius: 4px; border: 1px solid #9b59b6;">
        <h4 style="margin: 0 0 0.5rem 0;">‚úèÔ∏è Request Changes</h4>
        <p style="color: #666; font-size: 0.85rem; margin-bottom: 0.5rem;">
          Not quite right? Describe what to change and Copilot will create a new version.
        </p>
        <textarea 
          id="ai-revise-feedback" 
          rows="2" 
          placeholder="e.g., Make the button bigger and change the color to blue..."
          style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; resize: vertical;"
        ></textarea>
        <button 
          id="ai-revise-submit" 
          style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #9b59b6; color: white; border: none; border-radius: 4px; cursor: pointer;"
        >
          Request Changes
        </button>
        <span id="ai-revise-result" style="margin-left: 0.5rem;"></span>
      </div>
      
      <!-- Action Buttons -->
      <div id="ai-action-buttons" style="display: none; margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <button id="ai-approve" style="padding: 0.75rem 1rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
          ‚úÖ Apply Changes
        </button>
        <button id="ai-reject" style="padding: 0.75rem 1rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
          ‚ùå Discard
        </button>
        <button id="ai-revert" style="padding: 0.75rem 1rem; background: #f5a623; color: white; border: none; border-radius: 4px; cursor: pointer;">
          ‚Ü©Ô∏è Undo This Change
        </button>
        <a id="ai-pr-link" href="" target="_blank" style="padding: 0.75rem 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; text-decoration: none;">
          View PR on GitHub
        </a>
        <a id="ai-issue-link" href="" target="_blank" style="padding: 0.75rem 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; text-decoration: none;">
          View Issue
        </a>
      </div>
      
      <div id="ai-action-result" style="margin-top: 0.5rem;"></div>
    </div>
  </div>

  <script define:vars={{ workerUrl }}>
    const uploadBtn = document.getElementById('btn-upload');
    const modifyBtn = document.getElementById('btn-modify');
    const aiBtn = document.getElementById('btn-ai');
    const uploadForm = document.getElementById('upload-form');
    const modifyForm = document.getElementById('modify-form');
    const aiModPanel = document.getElementById('ai-mod-panel');

    function hideAll() {
      uploadForm.style.display = 'none';
      modifyForm.style.display = 'none';
      aiModPanel.style.display = 'none';
    }

    uploadBtn?.addEventListener('click', () => {
      hideAll();
      uploadForm.style.display = 'block';
    });

    modifyBtn?.addEventListener('click', () => {
      hideAll();
      modifyForm.style.display = 'block';
      loadComics();
    });

    aiBtn?.addEventListener('click', () => {
      hideAll();
      aiModPanel.style.display = 'block';
    });

    // Upload form submission
    const form = document.getElementById('comic-form');
    const resultDiv = document.getElementById('form-result');

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      
      const metadata = {
        title: formData.get('title'),
        slug: formData.get('slug'),
        altText: formData.get('altText'),
        transcript: formData.get('transcript'),
      };
      
      const submitData = new FormData();
      submitData.append('json', JSON.stringify(metadata));
      submitData.append('image', formData.get('image'));
      
      resultDiv.innerHTML = 'Uploading...';
      
      try {
        const response = await fetch(`${workerUrl}/api/comics`, {
          method: 'POST',
          body: submitData,
        });
        const result = await response.json();
        if (result.success) {
          resultDiv.innerHTML = `<span style="color: green;">‚úì Comic created! ID: ${result.data._id}</span>`;
          form.reset();
        } else {
          resultDiv.innerHTML = `<span style="color: red;">‚úó Error: ${result.error}</span>`;
        }
      } catch (err) {
        resultDiv.innerHTML = `<span style="color: red;">‚úó Network error: ${err}</span>`;
      }
    });

    // Modify comic functionality
    let comicsCache = [];
    let showHiddenOnly = false;
    
    const showHiddenToggle = document.getElementById('show-hidden-toggle');
    showHiddenToggle?.addEventListener('change', (e) => {
      showHiddenOnly = e.target.checked;
      updateComicSelect();
    });
    
    async function loadComics() {
      const select = document.getElementById('comic-select');
      try {
        const response = await fetch('/api/comics');
        const result = await response.json();
        if (result.success) {
          comicsCache = result.data;
          updateComicSelect();
        } else {
          select.innerHTML = '<option value="">Error loading comics</option>';
        }
      } catch (err) {
        select.innerHTML = '<option value="">Failed to load comics</option>';
      }
    }
    
    function updateComicSelect() {
      const select = document.getElementById('comic-select');
      const filteredComics = showHiddenOnly 
        ? comicsCache.filter(c => c.hidden === true)
        : comicsCache.filter(c => c.hidden !== true);
      
      select.innerHTML = '<option value="">Select a comic...</option>';
      
      if (filteredComics.length === 0) {
        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = showHiddenOnly ? 'No hidden comics' : 'No visible comics';
        emptyOption.disabled = true;
        select.appendChild(emptyOption);
        return;
      }
      
      filteredComics.forEach(comic => {
        const option = document.createElement('option');
        option.value = comic._id;
        const hiddenLabel = comic.hidden ? ' üôà' : '';
        option.textContent = `${comic.title} (${comic.slug.current})${hiddenLabel}`;
        select.appendChild(option);
      });
      
      // Reset form when switching views
      document.getElementById('modify-comic-form').style.display = 'none';
    }

    const comicSelect = document.getElementById('comic-select');
    const modifyComicForm = document.getElementById('modify-comic-form');
    const hiddenBadge = document.getElementById('hidden-badge');
    const toggleHideBtn = document.getElementById('btn-toggle-hide');
    
    comicSelect?.addEventListener('change', (e) => {
      const comicId = e.target.value;
      if (!comicId) {
        modifyComicForm.style.display = 'none';
        return;
      }
      
      const comic = comicsCache.find(c => c._id === comicId);
      if (!comic) return;
      
      document.getElementById('modify-comic-id').value = comic._id;
      document.getElementById('modify-title').value = comic.title || '';
      document.getElementById('modify-slug').value = comic.slug?.current || '';
      document.getElementById('modify-alt').value = comic.altText || '';
      document.getElementById('modify-transcript').value = comic.transcript || '';
      
      const preview = document.getElementById('modify-preview');
      if (comic.imageUrl) {
        preview.src = comic.imageUrl;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
      
      // Update hidden badge and button
      if (comic.hidden) {
        hiddenBadge.style.display = 'block';
        toggleHideBtn.textContent = 'üëÅÔ∏è Unhide';
        toggleHideBtn.style.background = '#28a745';
      } else {
        hiddenBadge.style.display = 'none';
        toggleHideBtn.textContent = 'üôà Hide';
        toggleHideBtn.style.background = '#ffc107';
        toggleHideBtn.style.color = '#000';
      }
      
      modifyComicForm.style.display = 'flex';
    });

    const modifyResultDiv = document.getElementById('modify-result');
    
    modifyComicForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(modifyComicForm);
      const comicId = formData.get('comicId');
      
      const metadata = {
        title: formData.get('title'),
        slug: formData.get('slug'),
        altText: formData.get('altText'),
        transcript: formData.get('transcript'),
      };
      
      const submitData = new FormData();
      submitData.append('json', JSON.stringify(metadata));
      
      const imageFile = formData.get('image');
      if (imageFile && imageFile.size > 0) {
        submitData.append('image', imageFile);
      }
      
      modifyResultDiv.innerHTML = 'Saving changes...';
      
      try {
        const response = await fetch(`${workerUrl}/api/comics/${comicId}`, {
          method: 'PATCH',
          body: submitData,
        });
        const result = await response.json();
        if (result.success) {
          modifyResultDiv.innerHTML = `<span style="color: green;">‚úì Comic updated successfully!</span>`;
          loadComics();
        } else {
          modifyResultDiv.innerHTML = `<span style="color: red;">‚úó Error: ${result.error}</span>`;
        }
      } catch (err) {
        modifyResultDiv.innerHTML = `<span style="color: red;">‚úó Network error: ${err}</span>`;
      }
    });

    // Hide/Unhide functionality
    toggleHideBtn?.addEventListener('click', async () => {
      const comicId = document.getElementById('modify-comic-id').value;
      const comic = comicsCache.find(c => c._id === comicId);
      if (!comic) return;
      
      const newHiddenState = !comic.hidden;
      modifyResultDiv.innerHTML = newHiddenState ? 'Hiding comic...' : 'Unhiding comic...';
      
      try {
        const response = await fetch(`${workerUrl}/api/comics/${comicId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hidden: newHiddenState }),
        });
        const result = await response.json();
        if (result.success) {
          modifyResultDiv.innerHTML = `<span style="color: green;">‚úì Comic ${newHiddenState ? 'hidden' : 'unhidden'}!</span>`;
          loadComics();
          modifyComicForm.style.display = 'none';
        } else {
          modifyResultDiv.innerHTML = `<span style="color: red;">‚úó Error: ${result.error}</span>`;
        }
      } catch (err) {
        modifyResultDiv.innerHTML = `<span style="color: red;">‚úó Network error: ${err}</span>`;
      }
    });

    // Delete functionality
    const deleteBtn = document.getElementById('btn-delete');
    const deleteModal = document.getElementById('delete-modal');
    const deleteCancel = document.getElementById('delete-cancel');
    const deleteConfirm = document.getElementById('delete-confirm');
    const deleteComicTitle = document.getElementById('delete-comic-title');
    let comicToDelete = null;
    
    deleteBtn?.addEventListener('click', () => {
      const comicId = document.getElementById('modify-comic-id').value;
      const comic = comicsCache.find(c => c._id === comicId);
      if (!comic) return;
      
      comicToDelete = comic;
      deleteComicTitle.textContent = comic.title;
      deleteModal.style.display = 'flex';
    });
    
    deleteCancel?.addEventListener('click', () => {
      deleteModal.style.display = 'none';
      comicToDelete = null;
    });
    
    deleteConfirm?.addEventListener('click', async () => {
      if (!comicToDelete) return;
      
      deleteModal.style.display = 'none';
      modifyResultDiv.innerHTML = 'Deleting comic permanently...';
      
      try {
        const response = await fetch(`${workerUrl}/api/comics/${comicToDelete._id}`, {
          method: 'DELETE',
        });
        const result = await response.json();
        if (result.success) {
          modifyResultDiv.innerHTML = `<span style="color: green;">‚úì Comic "${comicToDelete.title}" deleted permanently.</span>`;
          comicToDelete = null;
          loadComics();
          modifyComicForm.style.display = 'none';
        } else {
          modifyResultDiv.innerHTML = `<span style="color: red;">‚úó Error: ${result.error}</span>`;
        }
      } catch (err) {
        modifyResultDiv.innerHTML = `<span style="color: red;">‚úó Network error: ${err}</span>`;
      }
    });
    
    // Close modal on backdrop click
    deleteModal?.addEventListener('click', (e) => {
      if (e.target === deleteModal) {
        deleteModal.style.display = 'none';
        comicToDelete = null;
      }
    });

    // AI Modification functionality
    const aiSubmitBtn = document.getElementById('ai-submit');
    const aiDescription = document.getElementById('ai-description');
    const aiRequestResult = document.getElementById('ai-request-result');
    const aiListContent = document.getElementById('ai-list-content');
    const aiRefreshBtn = document.getElementById('ai-refresh-list');
    const aiDetailPanel = document.getElementById('ai-detail-panel');
    const aiDetailTitle = document.getElementById('ai-detail-title');
    const aiDetailStatus = document.getElementById('ai-detail-status');
    const aiCloseDetail = document.getElementById('ai-close-detail');
    const aiPreviewSection = document.getElementById('ai-preview-section');
    const aiPreviewIframe = document.getElementById('ai-preview-iframe');
    const aiPreviewLink = document.getElementById('ai-preview-link');
    const aiActionButtons = document.getElementById('ai-action-buttons');
    const aiApproveBtn = document.getElementById('ai-approve');
    const aiRejectBtn = document.getElementById('ai-reject');
    const aiRevertBtn = document.getElementById('ai-revert');
    const aiPrLink = document.getElementById('ai-pr-link');
    const aiIssueLink = document.getElementById('ai-issue-link');
    const aiActionResult = document.getElementById('ai-action-result');
    const aiReviseSection = document.getElementById('ai-revise-section');
    const aiReviseFeedback = document.getElementById('ai-revise-feedback');
    const aiReviseSubmit = document.getElementById('ai-revise-submit');
    const aiReviseResult = document.getElementById('ai-revise-result');

    let currentAiRequest = null;
    let aiRequestsCache = [];

    // Load list when AI panel is shown
    aiBtn?.addEventListener('click', () => {
      loadAiRequestsList();
    });

    aiRefreshBtn?.addEventListener('click', loadAiRequestsList);

    async function loadAiRequestsList() {
      aiListContent.innerHTML = '<p style="color: #666;">Loading...</p>';
      
      try {
        const response = await fetch(`${workerUrl}/api/ai-mod/list`);
        const result = await response.json();
        
        if (result.success) {
          aiRequestsCache = result.data;
          renderAiRequestsList();
        } else {
          aiListContent.innerHTML = `<p style="color: red;">Error: ${result.error}</p>`;
        }
      } catch (err) {
        aiListContent.innerHTML = `<p style="color: red;">Failed to load: ${err}</p>`;
      }
    }

    function renderAiRequestsList() {
      if (aiRequestsCache.length === 0) {
        aiListContent.innerHTML = '<p style="color: #666;">No requests yet. Submit one above!</p>';
        return;
      }

      const html = aiRequestsCache.map(req => {
        const statusIcon = getStatusIcon(req.status);
        const date = new Date(req.createdAt).toLocaleDateString();
        const stateClass = req.issueState === 'closed' ? 'color: #666;' : '';
        
        return `
          <div 
            class="ai-request-item" 
            data-issue="${req.issueNumber}"
            style="padding: 0.75rem; margin-bottom: 0.5rem; background: white; border-radius: 4px; cursor: pointer; border-left: 4px solid ${getStatusColor(req.status)}; ${stateClass}"
          >
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div style="flex: 1;">
                <strong>${statusIcon} ${escapeHtml(req.description)}</strong>
                <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                  #${req.issueNumber} ‚Ä¢ ${date} ‚Ä¢ ${getStatusLabel(req.status)}
                </div>
              </div>
              ${req.previewUrl ? '<span style="color: #9b59b6; font-size: 0.8rem;">Preview ‚úì</span>' : ''}
            </div>
          </div>
        `;
      }).join('');

      aiListContent.innerHTML = html;

      // Add click handlers
      aiListContent.querySelectorAll('.ai-request-item').forEach(item => {
        item.addEventListener('click', () => {
          const issueNumber = parseInt(item.dataset.issue);
          const req = aiRequestsCache.find(r => r.issueNumber === issueNumber);
          if (req) showRequestDetail(req);
        });
      });
    }

    function getStatusIcon(status) {
      switch (status) {
        case 'pending': return '‚è≥';
        case 'building': return 'üî®';
        case 'preview_ready': return 'üëÅÔ∏è';
        case 'applied': return '‚úÖ';
        case 'replaced': return 'üîÑ';
        case 'discarded': return '‚ùå';
        default: return '‚ùì';
      }
    }

    function getStatusColor(status) {
      switch (status) {
        case 'pending': return '#f5a623';
        case 'building': return '#4a9eff';
        case 'preview_ready': return '#9b59b6';
        case 'applied': return '#28a745';
        case 'replaced': return '#999';
        case 'discarded': return '#dc3545';
        default: return '#ccc';
      }
    }

    function getStatusLabel(status) {
      switch (status) {
        case 'pending': return 'Waiting for Copilot';
        case 'building': return 'Building preview...';
        case 'preview_ready': return 'Ready to review';
        case 'applied': return 'Applied';
        case 'replaced': return 'Replaced';
        case 'discarded': return 'Discarded';
        default: return status;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showRequestDetail(req) {
      currentAiRequest = req;
      aiDetailTitle.textContent = req.description;
      aiIssueLink.href = req.issueUrl;
      aiActionResult.innerHTML = '';
      aiReviseFeedback.value = '';
      aiReviseResult.innerHTML = '';

      // Set status
      let statusHtml = '';
      switch (req.status) {
        case 'pending':
          statusHtml = `<p>‚è≥ <strong>Waiting for Copilot...</strong></p>
            <p style="color: #666; font-size: 0.9rem;">Copilot should pick up this request shortly.</p>`;
          aiPreviewSection.style.display = 'none';
          aiReviseSection.style.display = 'none';
          aiActionButtons.style.display = 'flex';
          aiApproveBtn.style.display = 'none';
          aiRejectBtn.style.display = 'none';
          aiRevertBtn.style.display = 'none';
          aiPrLink.style.display = 'none';
          break;
        case 'building':
          statusHtml = `<p>üî® <strong>Building Preview...</strong></p>
            <p style="color: #666; font-size: 0.9rem;">Copilot opened <a href="${req.prUrl}" target="_blank">PR #${req.prNumber}</a>. Preview is being built.</p>
            ${req.previewUrl ? `<p style="color: #666; font-size: 0.9rem;">Preview URL (may not be ready yet): <a href="${req.previewUrl}" target="_blank">${req.previewUrl}</a></p>` : ''}`;
          aiPrLink.href = req.prUrl;
          aiPrLink.style.display = 'inline-block';
          aiPreviewSection.style.display = 'none';
          aiReviseSection.style.display = 'block';
          aiActionButtons.style.display = 'flex';
          aiApproveBtn.style.display = 'inline-block';
          aiRejectBtn.style.display = 'inline-block';
          aiRevertBtn.style.display = 'none';
          break;
        case 'preview_ready':
          statusHtml = `<p>üëÅÔ∏è <strong>Ready to Review</strong></p>
            <p style="color: #666; font-size: 0.9rem;">Review the preview below, then apply or request changes.</p>`;
          aiPreviewIframe.src = req.previewUrl;
          aiPreviewLink.href = req.previewUrl;
          aiPrLink.href = req.prUrl;
          aiPrLink.style.display = 'inline-block';
          aiPreviewSection.style.display = 'block';
          aiReviseSection.style.display = 'block';
          aiActionButtons.style.display = 'flex';
          aiApproveBtn.style.display = 'inline-block';
          aiRejectBtn.style.display = 'inline-block';
          aiRevertBtn.style.display = 'none';
          break;
        case 'applied':
          statusHtml = `<p>‚úÖ <strong>Applied</strong></p>
            <p style="color: #666; font-size: 0.9rem;">This change is live on your site.</p>`;
          aiPreviewSection.style.display = 'none';
          aiReviseSection.style.display = 'none';
          aiActionButtons.style.display = 'flex';
          aiApproveBtn.style.display = 'none';
          aiRejectBtn.style.display = 'none';
          aiRevertBtn.style.display = 'inline-block';
          if (req.prUrl) {
            aiPrLink.href = req.prUrl;
            aiPrLink.style.display = 'inline-block';
          } else {
            aiPrLink.style.display = 'none';
          }
          break;
        case 'replaced':
          statusHtml = `<p>üîÑ <strong>Replaced</strong></p>
            <p style="color: #666; font-size: 0.9rem;">This request was replaced by a newer version.</p>`;
          aiPreviewSection.style.display = 'none';
          aiReviseSection.style.display = 'none';
          aiActionButtons.style.display = 'flex';
          aiApproveBtn.style.display = 'none';
          aiRejectBtn.style.display = 'none';
          aiRevertBtn.style.display = 'none';
          aiPrLink.style.display = 'none';
          break;
        case 'discarded':
          statusHtml = `<p>‚ùå <strong>Discarded</strong></p>
            <p style="color: #666; font-size: 0.9rem;">This request was discarded.</p>`;
          aiPreviewSection.style.display = 'none';
          aiReviseSection.style.display = 'none';
          aiActionButtons.style.display = 'flex';
          aiApproveBtn.style.display = 'none';
          aiRejectBtn.style.display = 'none';
          aiRevertBtn.style.display = 'none';
          aiPrLink.style.display = 'none';
          break;
      }
      aiDetailStatus.innerHTML = statusHtml;
      aiDetailPanel.style.display = 'block';
    }

    aiCloseDetail?.addEventListener('click', () => {
      aiDetailPanel.style.display = 'none';
      aiPreviewIframe.src = '';
      currentAiRequest = null;
    });

    // Submit new request
    aiSubmitBtn?.addEventListener('click', async () => {
      const description = aiDescription.value.trim();
      if (!description) {
        aiRequestResult.innerHTML = '<span style="color: red;">Please enter a description</span>';
        return;
      }

      aiSubmitBtn.disabled = true;
      aiRequestResult.innerHTML = '‚è≥ Creating request...';

      try {
        const response = await fetch(`${workerUrl}/api/ai-mod/request`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ description }),
        });
        const result = await response.json();
        
        if (result.success) {
          const copilotNote = result.data.copilotAssigned 
            ? '' 
            : '<br><span style="color: #f5a623;">‚ö†Ô∏è Copilot not auto-assigned. <a href="' + result.data.issueUrl + '" target="_blank">Assign @copilot manually</a>.</span>';
          aiRequestResult.innerHTML = `<span style="color: green;">‚úì Created! <a href="${result.data.issueUrl}" target="_blank">Issue #${result.data.issueNumber}</a></span>${copilotNote}`;
          aiDescription.value = '';
          // Refresh the list
          setTimeout(loadAiRequestsList, 1000);
        } else {
          aiRequestResult.innerHTML = `<span style="color: red;">‚úó Error: ${result.error}</span>`;
        }
      } catch (err) {
        aiRequestResult.innerHTML = `<span style="color: red;">‚úó Network error: ${err}</span>`;
      } finally {
        aiSubmitBtn.disabled = false;
      }
    });

    aiApproveBtn?.addEventListener('click', async () => {
      if (!currentAiRequest?.prNumber) return;
      
      aiApproveBtn.disabled = true;
      aiActionResult.innerHTML = '‚è≥ Applying changes...';

      try {
        const response = await fetch(`${workerUrl}/api/ai-mod/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prNumber: currentAiRequest.prNumber }),
        });
        const result = await response.json();
        
        if (result.success) {
          aiActionResult.innerHTML = '<span style="color: green;">‚úì Changes applied! Site will update shortly.</span>';
          currentAiRequest.status = 'applied';
          showRequestDetail(currentAiRequest);
          loadAiRequestsList();
        } else {
          const details = result.details ? ` (${result.details})` : '';
          aiActionResult.innerHTML = `<span style="color: red;">‚úó Error: ${result.error}${details}</span>`;
        }
      } catch (err) {
        aiActionResult.innerHTML = `<span style="color: red;">‚úó Network error: ${err}</span>`;
      } finally {
        aiApproveBtn.disabled = false;
      }
    });

    aiRejectBtn?.addEventListener('click', async () => {
      if (!currentAiRequest?.prNumber) return;
      
      aiRejectBtn.disabled = true;
      aiActionResult.innerHTML = '‚è≥ Discarding changes...';

      try {
        const response = await fetch(`${workerUrl}/api/ai-mod/reject`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            prNumber: currentAiRequest.prNumber,
            issueNumber: currentAiRequest.issueNumber,
          }),
        });
        const result = await response.json();
        
        if (result.success) {
          aiActionResult.innerHTML = '<span style="color: green;">‚úì Changes discarded.</span>';
          aiDetailPanel.style.display = 'none';
          currentAiRequest = null;
          loadAiRequestsList();
        } else {
          aiActionResult.innerHTML = `<span style="color: red;">‚úó Error: ${result.error}</span>`;
        }
      } catch (err) {
        aiActionResult.innerHTML = `<span style="color: red;">‚úó Network error: ${err}</span>`;
      } finally {
        aiRejectBtn.disabled = false;
      }
    });

    // Request Changes (revise)
    aiReviseSubmit?.addEventListener('click', async () => {
      if (!currentAiRequest?.issueNumber || !currentAiRequest?.prNumber) return;
      
      const feedback = aiReviseFeedback.value.trim();
      if (!feedback) {
        aiReviseResult.innerHTML = '<span style="color: red;">Please describe what to change</span>';
        return;
      }

      aiReviseSubmit.disabled = true;
      aiReviseResult.innerHTML = '‚è≥ Creating new version...';

      try {
        const response = await fetch(`${workerUrl}/api/ai-mod/revise`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            issueNumber: currentAiRequest.issueNumber,
            prNumber: currentAiRequest.prNumber,
            originalDescription: currentAiRequest.description,
            feedback,
          }),
        });
        const result = await response.json();
        
        if (result.success) {
          const copilotNote = result.data.copilotAssigned 
            ? '' 
            : ' (assign @copilot manually)';
          aiReviseResult.innerHTML = `<span style="color: green;">‚úì New version requested! <a href="${result.data.issueUrl}" target="_blank">View</a>${copilotNote}</span>`;
          aiReviseFeedback.value = '';
          // Refresh list after a moment
          setTimeout(() => {
            loadAiRequestsList();
            aiDetailPanel.style.display = 'none';
          }, 1500);
        } else {
          aiReviseResult.innerHTML = `<span style="color: red;">‚úó ${result.error}</span>`;
        }
      } catch (err) {
        aiReviseResult.innerHTML = `<span style="color: red;">‚úó Network error</span>`;
      } finally {
        aiReviseSubmit.disabled = false;
      }
    });

    // Revert (undo merged changes)
    aiRevertBtn?.addEventListener('click', async () => {
      if (!currentAiRequest?.prNumber) return;
      
      aiRevertBtn.disabled = true;
      aiActionResult.innerHTML = '‚è≥ Creating revert request...';

      try {
        const response = await fetch(`${workerUrl}/api/ai-mod/revert`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            prNumber: currentAiRequest.prNumber,
            description: currentAiRequest.description,
          }),
        });
        const result = await response.json();
        
        if (result.success) {
          const copilotNote = result.data.copilotAssigned 
            ? '' 
            : ' (assign @copilot manually)';
          aiActionResult.innerHTML = `<span style="color: green;">‚úì Revert request created! <a href="${result.data.issueUrl}" target="_blank">Issue #${result.data.issueNumber}</a>${copilotNote}</span>`;
          // Refresh list to show the new revert request
          setTimeout(loadAiRequestsList, 1000);
        } else {
          aiActionResult.innerHTML = `<span style="color: red;">‚úó Error: ${result.error}</span>`;
        }
      } catch (err) {
        aiActionResult.innerHTML = `<span style="color: red;">‚úó Network error: ${err}</span>`;
      } finally {
        aiRevertBtn.disabled = false;
      }
    });
  </script>
</BaseLayout>
